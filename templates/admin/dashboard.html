{% extends "base.html" %}

{% block title %}Painel Administrativo | Controle Geral{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="container">
        {% block admin_header %}
    <h1>âš¡ Painel administrativo</h1>
    <p class="admin-subtitle">Bem-vindo, <strong>{{ current_user.username }}</strong></p>
        {% endblock %}

        <div class="admin-nav">
            <a href="{{ url_for('admin_dashboard') }}" class="{% if request.endpoint == 'admin_dashboard' %}active{% endif %}"><i class="fas fa-home"></i> Painel</a>
            <a href="{{ url_for('admin_contacts') }}" class="{% if request.endpoint == 'admin_contacts' %}active{% endif %}"><i class="fas fa-envelope"></i> Mensagens</a>
            <a href="{{ url_for('admin_blog') }}" class="{% if request.endpoint in ('admin_blog', 'create_post', 'edit_post') %}active{% endif %}"><i class="fas fa-blog"></i> Blog</a>
            <a href="{{ url_for('admin_projects') }}" class="{% if request.endpoint in ('admin_projects', 'create_project', 'edit_project') %}active{% endif %}"><i class="fas fa-folder"></i> Projetos</a>
            <a href="{{ url_for('admin_appointments') }}" class="{% if request.endpoint == 'admin_appointments' %}active{% endif %}"><i class="fas fa-calendar"></i> Agendamentos</a>
            <a href="{{ url_for('logout') }}" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>

        {% block admin_header_actions %}{% endblock %}
    </div>
</div>

<div class="container">
    {% block admin_content %}
    <div class="admin-stats-grid">
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-envelope"></i></div>
            <div class="stat-number">{{ stats.total_contacts }}</div>
            <div class="stat-label">Total de Mensagens</div>
        </div>
        
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-envelope-open"></i></div>
            <div class="stat-number">{{ stats.unread_contacts }}</div>
            <div class="stat-label">NÃ£o Lidas</div>
        </div>
        
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-blog"></i></div>
            <div class="stat-number">{{ stats.total_posts }}</div>
            <div class="stat-label">Posts Publicados</div>
        </div>
        
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-folder"></i></div>
            <div class="stat-number">{{ stats.total_projects }}</div>
            <div class="stat-label">Projetos</div>
        </div>
        
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-calendar"></i></div>
            <div class="stat-number">{{ stats.pending_appointments }}</div>
            <div class="stat-label">Agendamentos Pendentes</div>
        </div>
        
        <div class="card stat-card admin">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-number">{{ stats.confirmed_appointments }}</div>
            <div class="stat-label">Agendamentos Confirmados</div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="analytics-grid">
            <div class="card chart-card">
                <h2>ðŸ“ˆ EvoluÃ§Ã£o das interaÃ§Ãµes</h2>
                <p class="text-muted">VisÃ£o consolidada dos Ãºltimos 14 dias com trÃ¡fego, contatos, agendamentos e comentÃ¡rios.</p>
                <canvas id="metricsChart" height="220"></canvas>
            </div>
            <div class="card popular-card">
                <h2>ðŸ”¥ Posts em alta</h2>
                <ul class="popular-list">
                    {% for post, comment_total in popular_posts %}
                    <li class="popular-item">
                        <div>
                            <strong>{{ post.title }}</strong>
                            <span><i class="fas fa-calendar"></i> {{ post.created_at.strftime('%d/%m/%Y') }}</span>
                        </div>
                        <span class="popular-count"><i class="fas fa-comments"></i> {{ comment_total }}</span>
                    </li>
                    {% else %}
                    <li class="text-muted">Sem dados suficientes ainda. Publique e incentive comentÃ¡rios.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="recent-section">
        <h2>ðŸ“¨ Mensagens recentes</h2>
        <div class="recent-list">
            {% for contact in recent_contacts %}
            <div class="card recent-item">
                <div class="recent-item-header">
                    <div>
                        <div class="recent-item-title">{{ contact.name }}</div>
                        <div class="recent-item-contact">
                            <i class="fas fa-envelope"></i> {{ contact.email }}
                        </div>
                    </div>
                    <div class="recent-item-meta">
                        {% if not contact.read %}
                        <span class="badge badge-new status-label">Nova</span>
                        {% endif %}
                        <div class="recent-item-date">
                            <i class="fas fa-clock"></i> {{ contact.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </div>
                    </div>
                </div>
                <div class="recent-item-content">{{ contact.message[:150] }}{% if contact.message|length > 150 %}...{% endif %}</div>
            </div>
            {% else %}
            <div class="card empty-card">
                <i class="fas fa-inbox"></i>
                <p>Nenhuma mensagem ainda</p>
            </div>
            {% endfor %}
        </div>
        <div class="action-row">
            <a href="{{ url_for('admin_contacts') }}" class="btn btn-primary">
                <i class="fas fa-arrow-right"></i> Ver todas as mensagens
            </a>
        </div>
    </div>
    
    <div class="recent-section">
        <h2>ðŸ“… PrÃ³ximos agendamentos</h2>
        <div class="recent-list">
            {% set status_labels = {
                'pending': 'Pendente',
                'confirmed': 'Confirmado',
                'cancelled': 'Cancelado',
                'canceled': 'Cancelado'
            } %}
            {% for appointment in recent_appointments %}
            <div class="card recent-item">
                <div class="recent-item-header">
                    <div>
                        <div class="recent-item-title">{{ appointment.name }}</div>
                        <div class="recent-item-contact">
                            <i class="fas fa-phone"></i> {{ appointment.phone }}
                        </div>
                    </div>
                    <div class="recent-item-meta">
                        <span class="badge badge-{{ appointment.status }} status-label">{{ status_labels.get(appointment.status, appointment.status)|upper }}</span>
                        <div class="recent-item-date">
                            <i class="fas fa-calendar"></i> {{ appointment.date.strftime('%d/%m/%Y') }} Ã s {{ appointment.time }}
                        </div>
                    </div>
                </div>
                <div class="recent-item-content">{{ appointment.message[:150] }}{% if appointment.message|length > 150 %}...{% endif %}</div>
            </div>
            {% else %}
            <div class="card empty-card">
                <i class="fas fa-calendar-times"></i>
                <p>Nenhum agendamento pendente</p>
            </div>
            {% endfor %}
        </div>
        <div class="action-row">
            <a href="{{ url_for('admin_appointments') }}" class="btn btn-primary">
                <i class="fas fa-arrow-right"></i> Gerenciar agendamentos
            </a>
        </div>
    </div>
    {% endblock %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
{% if chart_labels is defined %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
    const metricsCanvas = document.getElementById('metricsChart');
    if (metricsCanvas) {
        const metricsChart = new Chart(metricsCanvas, {
            type: 'line',
            data: {
                labels: {{ chart_labels|default('[]')|safe }},
                datasets: [
                    {
                        label: 'VisualizaÃ§Ãµes',
                        data: {{ chart_page_views|default('[]')|safe }},
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.15)',
                        tension: 0.35,
                        borderWidth: 3,
                        pointRadius: 4,
                        fill: true
                    },
                    {
                        label: 'Contatos',
                        data: {{ chart_contacts|default('[]')|safe }},
                        borderColor: '#ff7f50',
                        backgroundColor: 'rgba(255, 127, 80, 0.15)',
                        tension: 0.35,
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true
                    },
                    {
                        label: 'Agendamentos',
                        data: {{ chart_appointments|default('[]')|safe }},
                        borderColor: '#9b51ff',
                        backgroundColor: 'rgba(155, 81, 255, 0.15)',
                        tension: 0.35,
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true
                    },
                    {
                        label: 'ComentÃ¡rios',
                        data: {{ chart_comments|default('[]')|safe }},
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.15)',
                        tension: 0.35,
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--cor-texto') || '#fff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--cor-texto-secundario') || '#b0b0b0'
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--cor-texto-secundario') || '#b0b0b0',
                            precision: 0
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        }
                    }
                }
            }
        });

        const themeObserver = new MutationObserver(() => {
            metricsChart.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--cor-texto');
            metricsChart.options.scales.x.ticks.color = getComputedStyle(document.body).getPropertyValue('--cor-texto-secundario');
            metricsChart.options.scales.y.ticks.color = getComputedStyle(document.body).getPropertyValue('--cor-texto-secundario');
            metricsChart.update();
        });

        themeObserver.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });
    }
</script>
{% endif %}
{% endblock %}